import telebot
from telebot import types

TOKEN = '7933020801:AAG2jwlFORScA2GAMr7b_aVdfeZH2KRBMWU'
ADMIN_ID = 6618449790

bot = telebot.TeleBot(TOKEN)

gem_packages = {
    "86 Ø¬Ù…": {"price": "85,000 ØªÙˆÙ…Ø§Ù†", "desc": "Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯Ù‡Ø§ÛŒ Ú©ÙˆÚ†Ú©"},
    "172 Ø¬Ù…": {"price": "160,000 ØªÙˆÙ…Ø§Ù†", "desc": "Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ† Ø¨Ø³ØªÙ‡"},
    "257 Ø¬Ù…": {"price": "230,000 ØªÙˆÙ…Ø§Ù†", "desc": "Ø¨Ù‡â€ŒØµØ±ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ù¾Ù„ÛŒØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„"},
}

user_states = {}  # Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†

def main_menu():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.row("ğŸ’ Ø®Ø±ÛŒØ¯ Ø¬Ù… Mobile Legends")
    return markup

@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.send_message(message.chat.id, "Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¬Ù… Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ!\nÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=main_menu())

@bot.message_handler(func=lambda m: m.text == "ğŸ’ Ø®Ø±ÛŒØ¯ Ø¬Ù… Mobile Legends")
def show_packages(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    for pkg_name in gem_packages:
        markup.row(pkg_name)
    markup.row("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ")
    bot.send_message(message.chat.id, "ğŸ“¦ ÛŒÚ©ÛŒ Ø§Ø² Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¬Ù… Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text in gem_packages)
def show_package_detail(message):
    pkg = gem_packages[message.text]
    user_states[message.chat.id] = {'selected_package': message.text}
    text = f"ğŸ <b>{message.text}</b>\nğŸ’° Ù‚ÛŒÙ…Øª: {pkg['price']}\nâ„¹ï¸ {pkg['desc']}"
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.row("ğŸ›’ Ø®Ø±ÛŒØ¯")
    markup.row("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ")
    bot.send_message(message.chat.id, text, reply_markup=markup, parse_mode="HTML")

@bot.message_handler(func=lambda m: m.text == "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ")
def back_to_menu(message):
    user_states.pop(message.chat.id, None)
    bot.send_message(message.chat.id, "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ:", reply_markup=main_menu())

@bot.message_handler(func=lambda m: m.text == "ğŸ›’ Ø®Ø±ÛŒØ¯")
def handle_buy(message):
    user_state = user_states.get(message.chat.id)
    if not user_state or 'selected_package' not in user_state:
        bot.send_message(message.chat.id, "Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¨Ø³ØªÙ‡ Ø¬Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.")
        return
    
    user_state['waiting_for_receipt'] = True
    card_number = "6219861818197880"
    caption = (
        "ØªÙ†Ù‡Ø§ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù„Ø¬Ù†Ø¯Ø² Ø¢ÛŒâ€ŒØ¢Ø±\n\n"
        f"ğŸ’³<code>{card_number}</code>ğŸ’³\n\n"
        "ğŸ’ Ø·Ø§Ø±Ù‚ Ù†ØµØ§Ø±ÛŒ Ø¬Ø²ÛŒØ±Ù‡ ğŸ’\n"
        "âœ… Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯ + Ø¢ÛŒØ¯ÛŒ + Ø¢ÛŒØ¯ÛŒ Ø³Ø±ÙˆØ± Ø±Ùˆ Ù‡Ù…ÛŒÙ†Ø¬Ø§ Ø¨ÙØ±Ø³Øª âœ…"
    )
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("ğŸ“‹ Ú©Ù¾ÛŒ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª", switch_inline_query=card_number))
    bot.send_message(message.chat.id, caption, parse_mode="HTML", reply_markup=markup)

@bot.message_handler(content_types=['photo'])
def handle_receipt(message):
    user_state = user_states.get(message.chat.id, {})
    if user_state.get('waiting_for_receipt'):
        user_state['waiting_for_receipt'] = False
        selected_package = user_state.get('selected_package', 'Ù†Ø§Ù…Ø´Ø®Øµ')
        
        # Ù¾ÛŒØ§Ù… ØªØ§ÛŒÛŒØ¯ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        bot.reply_to(message, "âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ØŒ Ø¨Ø²ÙˆØ¯ÛŒ Ø´Ø§Ø±Ú˜ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.")
        
        # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
        text_to_admin = (
            f"ğŸ“¦ Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯\n"
            f"ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: [{message.from_user.first_name}](tg://user?id={message.chat.id})\n"
            f"ğŸ†” Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±: `{message.chat.id}`\n"
            f"ğŸ Ø¨Ø³ØªÙ‡: {selected_package}\n"
            f"ğŸ’¬ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø³ÛŒØ¯ØŒ Ø¹Ú©Ø³ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯."
        )
        
        # Ø¯Ú©Ù…Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯
        markup = types.InlineKeyboardMarkup()
        callback_data = f"order_done_{message.chat.id}"
        markup.add(types.InlineKeyboardButton("âœ… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯", callback_data=callback_data))
        
        # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ùˆ Ø¹Ú©Ø³ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
        bot.send_photo(ADMIN_ID, message.photo[-1].file_id, caption=text_to_admin, parse_mode="Markdown", reply_markup=markup)
    else:
        bot.reply_to(message, "âš ï¸ Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")

@bot.callback_query_handler(func=lambda call: call.data.startswith("order_done_"))
def callback_order_done(call):
    user_id_str = call.data.replace("order_done_", "")
    try:
        user_id = int(user_id_str)
    except:
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§ Ø¯Ø± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±.")
        return
    
    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ú©Ù‡ Ø³ÙØ§Ø±Ø´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯
    bot.send_message(user_id, "ğŸ‰ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø§Ø² Ø®Ø±ÛŒØ¯ØªÙˆÙ† Ù…Ù…Ù†ÙˆÙ†ÛŒÙ…!")
    
    # ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø§Ø¯Ù…ÛŒÙ† (Ø­Ø°Ù Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§)
    bot.edit_message_reply_markup(chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=None)
    bot.answer_callback_query(call.id, "Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯.")
    

@bot.message_handler(func=lambda m: user_states.get(m.chat.id, {}).get('waiting_for_receipt') and m.content_type != 'photo')
def warn_invalid_receipt(message):
    bot.reply_to(message, "âš ï¸ Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")

@bot.message_handler(func=lambda m: True)
def fallback(message):
    bot.send_message(message.chat.id, "Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.", reply_markup=main_menu())

app = Flask(__name__)

@app.route('/', methods=['GET'])
def index():
    return 'âœ… Bot is alive and running!', 200

@app.route('/', methods=['POST'])
def webhook():
    update = telebot.types.Update.de_json(request.stream.read().decode('utf-8'))
    bot.process_new_updates([update])
    return 'ok', 200

def run():
    app.run(host='0.0.0.0', port=8080)

threading.Thread(target=run).start()

bot.infinity_polling()
